# Regras do Projeto - JDS Sales

## ğŸ“‹ Contexto do Projeto

Este Ã© um **sistema de administraÃ§Ã£o de e-commerce** construÃ­do com:
- **Next.js 16.1.1** (App Router)
- **React 19.2.3**
- **TypeScript 5.9.3**
- **Supabase** (autenticaÃ§Ã£o e banco de dados)
- **Tailwind CSS 4.1.18**
- **Jest + React Testing Library** (testes)

O sistema possui controle de acesso baseado em roles:
- `super_admin`: Acesso total ao sistema
- `admin`: Administrador de loja especÃ­fica
- `user`: UsuÃ¡rio padrÃ£o

---

## ğŸŒ Idioma e ComunicaÃ§Ã£o

- **Sempre responda em PORTUGUÃŠS (pt-BR)**
- Use exemplos de cÃ³digo prÃ¡ticos e completos
- Explique o "por quÃª" das decisÃµes tÃ©cnicas apenas se eu perguntar.
- Seja direto e objetivo, mas educado
- Incluir comentÃ¡rios somente lÃ³gicos no cÃ³digo (como para identificar classes objetos e funÃ§Ãµes)
- Nunca utilizar Emojis.
- Ao responder a uma solicitaÃ§Ã£o com um passo a passo, nunca enviar mais de 1 passo de uma vez. Aguardar comando para o prÃ³ximo passo sempre.


---

## ğŸ“ Estrutura de Pastas

Seguir a estrutura padrÃ£o do Next.js App Router:

```
src/
â”œâ”€â”€ app/                    # Rotas e pÃ¡ginas (App Router)
â”‚   â”œâ”€â”€ (auth)/            # Grupo de rotas de autenticaÃ§Ã£o
â”‚   â”œâ”€â”€ (dashboard)/       # Grupo de rotas do dashboard
â”‚   â”œâ”€â”€ layout.tsx         # Layouts
â”‚   â””â”€â”€ page.tsx           # PÃ¡ginas
â”œâ”€â”€ components/            # Componentes React reutilizÃ¡veis
â”‚   â”œâ”€â”€ ui/               # Componentes de UI bÃ¡sicos
â”‚   â””â”€â”€ [Feature]/        # Componentes especÃ­ficos de features
â”œâ”€â”€ lib/                   # UtilitÃ¡rios e helpers
â”‚   â”œâ”€â”€ supabase/         # Clientes Supabase (client, server, middleware)
â”‚   â”œâ”€â”€ hooks/            # Custom hooks
â”‚   â””â”€â”€ types/            # Tipos TypeScript
â””â”€â”€ middleware.ts          # Middleware do Next.js
```

**Regras:**
- Componentes reutilizÃ¡veis em `src/components/`
- LÃ³gica de negÃ³cio em `src/lib/`
- PÃ¡ginas e rotas em `src/app/`
- Nunca colocar lÃ³gica de negÃ³cio diretamente em componentes de pÃ¡gina

---

## ğŸ’» PadrÃµes de CÃ³digo TypeScript

### Tipagem Estrita

- **Sempre use TypeScript estrito** (`strict: true`)
- Defina tipos explÃ­citos para props, estados e retornos de funÃ§Ã£o
- Use `interface` para objetos e `type` para uniÃµes e tipos derivados
- Evite `any` - use `unknown` quando necessÃ¡rio e faÃ§a type guards

**âœ… Bom:**
```typescript
interface UserProps {
  id: string
  name: string
  role: 'super_admin' | 'admin' | 'user'
}

function getUser(id: string): Promise<UserProps | null> {
  // ...
}
```

**âŒ Ruim:**
```typescript
function getUser(id: any): any {
  // ...
}
```

### Nomenclatura

- **Componentes**: PascalCase (`LoginPage.tsx`, `UserCard.tsx`)
- **Arquivos de utilitÃ¡rios**: camelCase (`user.ts`, `formatDate.ts`)
- **Hooks customizados**: camelCase com prefixo `use` (`useSessionTimeout.ts`)
- **Constantes**: UPPER_SNAKE_CASE (`SESSION_TIMEOUT_SECONDS`)
- **Tipos/Interfaces**: PascalCase (`UserRole`, `Database`)

---

## âš›ï¸ PadrÃµes React e Next.js

### Componentes

- **Sempre use componentes funcionais** (nÃ£o classes)
- Use `'use client'` apenas quando necessÃ¡rio (interatividade, hooks, eventos)
- Prefira Server Components por padrÃ£o
- Separe lÃ³gica de apresentaÃ§Ã£o da lÃ³gica de negÃ³cio

**âœ… Bom:**
```tsx
// Server Component (padrÃ£o)
export default async function DashboardPage() {
  const user = await getUserWithRole()
  return <Dashboard user={user} />
}

// Client Component (quando necessÃ¡rio)
'use client'
export function InteractiveButton() {
  const [loading, setLoading] = useState(false)
  // ...
}
```

### Hooks e Estado

- Use `useState` para estado local simples
- Use `useEffect` com cuidado - sempre inclua dependÃªncias
- Prefira Server Actions para mutations quando possÃ­vel
- Custom hooks para lÃ³gica reutilizÃ¡vel

**âœ… Bom:**
```tsx
const [email, setEmail] = useState<string>('')
const [errors, setErrors] = useState<{ email?: string }>({})
```

### FormulÃ¡rios

- Sempre valide no cliente E no servidor
- Use estados de loading e error
- Mensagens de erro amigÃ¡veis em portuguÃªs
- Desabilite botÃµes durante submit

---

## ğŸ¨ Design System e EstilizaÃ§Ã£o

### Paleta de Cores (Regra 60/30/10)

**SEMPRE seguir a identidade visual:**

- **60% - #333745** (Cinza escuro/Preto) - Cor principal
- **30% - #E8D7F1** (Lavanda claro) - Cor secundÃ¡ria  
- **10% - #D3BCCC** (Lavanda mÃ©dio) - Cor de destaque

**AplicaÃ§Ã£o:**
- Fundos principais: `#333745`
- Textos e elementos secundÃ¡rios: `#E8D7F1`
- BotÃµes e CTAs: `#D3BCCC`
- Textos escuros sobre fundo claro: `#333745`

### Tailwind CSS

- **Prefira classes Tailwind** sobre estilos inline
- Use `style={{}}` apenas para cores customizadas do design system
- Mantenha responsividade (mobile-first)
- Use `font-roboto` para manter fonte consistente

**âœ… Bom:**
```tsx
<div className="min-h-screen flex items-center justify-center py-12 px-4" style={{ backgroundColor: '#333745' }}>
  <button className="w-full py-4 px-6 rounded-lg font-semibold font-roboto" style={{ backgroundColor: '#D3BCCC', color: '#333745' }}>
    Entrar
  </button>
</div>
```

**âŒ Evitar:**
```tsx
<div style={{ minHeight: '100vh', display: 'flex', ... }}>
```

---

## ğŸ” SeguranÃ§a e AutenticaÃ§Ã£o

### Supabase

- **Nunca exponha `SUPABASE_SERVICE_ROLE_KEY`** no cliente
- Use `createClient()` do `@/lib/supabase/client` para Client Components
- Use `createClient()` do `@/lib/supabase/server` para Server Components
- Sempre valide autenticaÃ§Ã£o no middleware E no servidor

### SessÃ£o e Timeout

- **Timeout de sessÃ£o: 5 minutos** (300 segundos)
- Implementar `useSessionTimeout` em pÃ¡ginas protegidas
- Middleware deve verificar expiraÃ§Ã£o de sessÃ£o
- Cookies com `maxAge` configurado corretamente

### Controle de Acesso (RBAC)

- **Sempre verificar role no middleware** antes de permitir acesso
- Super Admin: acesso a `/super-admin/*`
- Admin: acesso apenas a `/admin/{store_id}/*` da sua loja
- UsuÃ¡rio: acesso a `/dashboard` (padrÃ£o)
- Redirecionar automaticamente baseado em role apÃ³s login

**âœ… Bom:**
```typescript
// middleware.ts
if (pathname.startsWith('/super-admin')) {
  if (userRole.role !== 'super_admin') {
    return NextResponse.redirect(new URL('/login', request.url))
  }
}
```

---

## ğŸ§ª Testes

### Regra ObrigatÃ³ria

**SEMPRE criar testes para:**
- Novos componentes
- Novas funcionalidades
- Hooks customizados
- UtilitÃ¡rios e helpers
- LÃ³gica de autenticaÃ§Ã£o/autorizaÃ§Ã£o

### Estrutura de Testes

- Arquivos de teste: `__tests__/[nome].test.tsx` ou `[nome].test.tsx`
- Use Jest + React Testing Library
- Mock de dependÃªncias externas (Supabase, Next.js router)
- Testes devem ser descritivos em portuguÃªs

**âœ… Bom:**
```typescript
describe('LoginPage', () => {
  it('deve exibir erro quando email Ã© invÃ¡lido', () => {
    // ...
  })
  
  it('deve redirecionar apÃ³s login bem-sucedido', () => {
    // ...
  })
})
```

### Executar Testes

```bash
npm test              # Executar todos os testes
npm run test:watch    # Modo watch
npm run test:coverage # Com cobertura
```

---

## ğŸ“¦ Imports e OrganizaÃ§Ã£o

### Ordem de Imports

1. React e Next.js
2. Bibliotecas externas
3. Imports internos (`@/lib`, `@/components`)
4. Tipos (no final, com `type`)

**âœ… Bom:**
```typescript
import { useState, FormEvent } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/Button'
import type { UserRole } from '@/lib/types'
```

### Path Aliases

- **Sempre use `@/`** para imports relativos a `src/`
- NÃ£o use `../../../` - use `@/lib/...`

---

## ğŸ—„ï¸ Banco de Dados (Supabase)

### Tipos do Banco

- **Sempre manter `database.types.ts` atualizado** com schema real
- Tipos devem refletir exatamente a estrutura do banco
- Use tipos gerados do Supabase quando possÃ­vel

### Queries

- Use `.select()` explÃ­cito (nÃ£o `*`)
- Sempre trate erros de query
- Use `.single()` quando esperar um Ãºnico resultado
- Valide dados retornados antes de usar

**âœ… Bom:**
```typescript
const { data, error } = await supabase
  .from('users')
  .select('id, name, role, store_id')
  .eq('id', user.id)
  .single()

if (error || !data) {
  return null
}
```

---

## ğŸš€ Performance

### OtimizaÃ§Ãµes

- Use `next/image` para imagens
- Lazy load de componentes pesados
- Server Components por padrÃ£o (menos JavaScript no cliente)
- Evite re-renders desnecessÃ¡rios (use `useMemo`, `useCallback` quando apropriado)

### Build e Deploy

- Sempre testar `npm run build` antes de commitar
- Verificar que nÃ£o hÃ¡ erros de TypeScript
- Verificar que todos os testes passam
- VariÃ¡veis de ambiente devem estar no `.env.example`

---

## ğŸ“ Commits e Git

### Mensagens de Commit

- Use portuguÃªs para mensagens
- Seja descritivo mas conciso
- Formato: `tipo: descriÃ§Ã£o breve`

**Exemplos:**
```
feat: adiciona redirecionamento baseado em role apÃ³s login
fix: corrige timeout de sessÃ£o no middleware
test: adiciona testes para pÃ¡gina de login
refactor: reorganiza estrutura de pastas dos componentes
```

### Arquivos a Ignorar

- `.env.local` (nunca commitar)
- `.env` (nunca commitar)
- `.env.example` (pode commitar)
- `node_modules/`
- `.next/`

---

## âš ï¸ Erros e Tratamento

### Tratamento de Erros

- **Sempre trate erros** de forma amigÃ¡vel
- Mensagens de erro em portuguÃªs para o usuÃ¡rio
- Logs de erro detalhados no console (dev)
- NÃ£o exponha detalhes tÃ©cnicos ao usuÃ¡rio final

**âœ… Bom:**
```typescript
try {
  const { error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) {
    if (error.message.includes('Invalid login credentials')) {
      setErrors({ general: 'Email ou senha incorretos.' })
    } else {
      setErrors({ general: 'Erro ao fazer login. Tente novamente.' })
    }
  }
} catch (err) {
  setErrors({ general: 'Erro inesperado. Tente novamente.' })
}
```

---

## ğŸ”„ Estado e Gerenciamento de Dados

### Estado Local vs Global

- **Prefira estado local** (`useState`) quando possÃ­vel
- Use Context API apenas quando necessÃ¡rio compartilhar estado entre muitos componentes
- Evite prop drilling excessivo

### Server vs Client State

- Dados do servidor: use Server Components e Server Actions
- Estado de UI (loading, modals): use Client Components
- Cache: use `revalidatePath` e `revalidateTag` do Next.js

---

## ğŸ“š DocumentaÃ§Ã£o

### ComentÃ¡rios no CÃ³digo

- Comente lÃ³gica complexa ou nÃ£o Ã³bvia
- Use JSDoc para funÃ§Ãµes pÃºblicas
- Mantenha comentÃ¡rios atualizados

**âœ… Bom:**
```typescript
/**
 * Busca informaÃ§Ãµes do usuÃ¡rio incluindo role e store_id
 * @returns UserWithRole ou null se nÃ£o encontrar
 */
export async function getUserWithRole(): Promise<UserWithRole | null> {
  // ...
}
```

### README e Docs

- Mantenha `README.md` atualizado
- Documente decisÃµes importantes em comentÃ¡rios
- Atualize `DESIGN_SYSTEM.md` quando houver mudanÃ§as

---

## âœ… Checklist Antes de Commitar

Antes de fazer commit, verificar:

- [ ] CÃ³digo compila sem erros (`npm run build`)
- [ ] Todos os testes passam (`npm test`)
- [ ] ESLint nÃ£o mostra erros (`npm run lint`)
- [ ] Testes foram criados para novas funcionalidades
- [ ] Tipos TypeScript estÃ£o corretos
- [ ] Cores seguem o design system (60/30/10)
- [ ] AutenticaÃ§Ã£o/autorizaÃ§Ã£o estÃ¡ funcionando
- [ ] Middleware protege rotas corretamente
- [ ] Mensagens de erro estÃ£o em portuguÃªs
- [ ] NÃ£o hÃ¡ console.logs ou cÃ³digo de debug
- [ ] VariÃ¡veis de ambiente estÃ£o no `.env.example` (se novas)

---

## ğŸ¯ Prioridades

1. **SeguranÃ§a**: Sempre a prioridade mÃ¡xima
2. **Testes**: Nunca pular criaÃ§Ã£o de testes
3. **TypeScript**: Tipagem estrita sempre
4. **Design System**: Seguir paleta de cores rigorosamente
5. **Performance**: Otimizar quando necessÃ¡rio
6. **UX**: Mensagens claras e feedback visual

---

**Ãšltima atualizaÃ§Ã£o**: 2024
**VersÃ£o**: 1.0
